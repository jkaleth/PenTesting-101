# Post-Exploitation

## Enumerating the Network
    - Host Enumeration
    - Network Enumeration
    - Infrastructure Enumeration
    - Privilege Escalation
    - Persistence
    - Covert channeles to exfiltrate data

**Step 1**- Search through Active Directory
```
Get Users Current Domain
ps:\ Get-NetDomain
```
```
Current Logged On Users
ps:\ Get-NetLoggenOn
```

**Step 1**- Enumeratin Linux Users

```
Liux user commands

$ cat /etc/passwd - display users on Linux machine
$ uname -a - display OS
$ env - list environmental variables
$

```

**Step 2**- Setup Network Sniffer

```
- Use Metasploit's capture packet function
- Using Wireshark to analyze packets

```

**Step 3**- Discover what's on the share drive to see what's unencrypted. 

# Network Segmentation Testing
Network segment is where all host can commuication freely with each other. Using subnets, vlans, and firewalls. 

#### Network segmentation fails when there's a:
    - Misconfigured Firewall
    - Legacy rules not removed from firewall
    - ANY:ANY permissions
    - 3rd party management service causing access

#### How to test segmentation is working properly:
    - Run port scan as that regular user on the environment you want to check access to to make sure you can't get an IP. 


## Lateral Movement and Pivoting
Search through the network to identify key data to get you to the target of a campaign. 

    - Pivoting - Use one infected computer to attack another. 

## Pass The Hash - Lateral Movement
    - Steal hashed user credentials and use them as-is snd try to authenticate with them on the same network and still be able to authenticate with SMB and Kerberos. 

    - It's commonly used to elevate privileges

### Mimikatz
    - Scans system memory for cached passwords processed by the local Security Authority Subsystem Service (lsass.exe)
    
    - you can use Metasploit 

## Golden Ticket _ lateral Movement
A Kerberos ticket than can grant other tickets in AD. They can can grant admin access to other domain members and controllers. 

    - krbtgt Hash - the trust anchor of an AD domain which functions as a private key of a root certificate authority and generates ticket-granting requests (TGT) that are used by users to access services withing Kerberos.

**How does this attack work?**
1. Attackers accessed NTDS.DIT 
2. Attacker dumps NTDS.DIT exposing Kerberos trust anchor. krbtgt
3. Response team resets credentials but not krbtgt. 
4. Attacker gets Golden ticket
5. Assumes Admin rights. 
6. Attacker can compromise DC with powershell

NOTE- ADMIN should change the krbgtg account password regularly. 

## Lateral Movement

#### Attackers can use these other tools to compromise and move laterally
    - Remote Access services- SSH, Telnet, RDP, and VNC allow lateral movement
    - WMIC (Windows Management Instrumentation Command lIne) Terminal interface to run scripts and manage computers. 
    - PsExec - Developed as an alternative to Telnet. 
    - Powershell - Explot Kits- The Powershel Empire. Controls prebuilt attack modules. 
    - DCOM

## Pivoting
- Attacker uses compromise host to spread attacks across the network. Hopping from one point to another. 

- Running attacks from a certain point (device) Pivot point. 

- Uses port forwarding the attacker uses a host as a pivot and then can access tcp/ip ports to send traffic to ports of hosts on differen subnets. 

- SSH -D sets up a local proxy and port forwarding. 

- Attackers can chain proxy servers together. 

- Modify routing tables. 

## Escalating Privileges
Exploting flaws in OS to gain greater level of access than intended. 

- **Horizontal-** Gaining access to regular user account to gain access to a different privilege level. 
- **Vertical-** Gaining access to highler level user account than current user. 

How can attackers who break into Linux systems use vertical movement to gain higher access? 
- Using SUID - Set-User Identification 
- Using SGID - Set-Group Identification 
- Sticky Bit - allows users to create files, read and execute files owned by other users. 
```
-t means a sticky bit has been set. 

$ -rwsr-xr-x-t
```
```
How to find SAMBA/Windows shares in linux:

- enum4linux
- Metasploit auxillary/scanner/smb/smb_enumshares
```
How to find SAMBA/Windows shares in linux:


```
How to find all applications that can be run as root:

$ sudo find / - perm -04000
```
### Accessing Credentials as a form of privilege escalation

**Kerboroasting-** Allows any domain user account that has a service principal name (SPN) to set a TGS (service-granting ticket)

**LSASS** - Local Security authority Subsystem Service. It enforces the security policy of a system. 

### DLL Hijacking 
method of sharing code. commonly used with Malware to maintain persistent. 

## Upgrading Restrictive Shells
A shell where you might be confined from running certain functions. 

### Using Linux

How to upgrade into a restrictivce shell:

**use python**

$ python -c 'import pty; pty.spawn("/bin/bash")'

**use perl**

$ perl -e 'exec /bin/sh";'

**use VI** it can also run commands. To launch a shell...

Launch vi and then:

:set  shell=/bin/sh :shell

### Meterpreter Script
an interactice shell you can use instead of command prompt or bash

## 
 
